@inject HttpClient Http;
@using Core;
@using Core.Models
@inject NavigationManager NavManager
@using Blazored.LocalStorage
@inject ILocalStorageService localStorage

@using KantineApp.Pages
<div style="max-width: 600px; margin: auto; margin-top: 2rem; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); background-color: #fff;">
    <div style="background-color: #007bff; color: white; padding: 1rem; border-radius: 8px 8px 0 0;">
        <h3 style="margin: 0;">Write a Message</h3>
    </div>
    <div style="padding: 1rem;">
        <EditForm Model="newMessage">
            <DataAnnotationsValidator />
            <ValidationSummary style="color: #dc3545; margin-bottom: 1rem;" />

            <div style="margin-bottom: 1rem;">
                <label for="employee" style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Recipient</label>
                <InputSelect id="employee" @bind-Value="newMessage.IdOfReceiver" style="width: 100%; padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;">
                    <option value="">Select an employee</option>
                    @foreach (var employee in employeeList)
                    {
                    <option value="@employee.Id">@employee.Name</option>
                    }
                </InputSelect>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="title" style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Title</label>
                <InputText id="title" @bind-Value="newMessage.Title" style="width: 100%; padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;" placeholder="Enter title" />
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="message" style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Message</label>
                <InputTextArea id="message" @bind-Value="newMessage.Message" style="width: 100%; padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;" rows="5" placeholder="Type your message here..." />
            </div>

            <div style="text-align: right; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" @onclick="NavigateToInbox"
                        style="padding: 0.5rem 1rem; font-size: 1rem; margin-right: 0.5rem; background-color: #6c757d; color: white; border: none; border-radius: 6px;">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" @onclick="SendMessage" style="padding: 0.5rem 1rem; font-size: 1rem; background-color: #007bff; color: white; border: none; border-radius: 6px;">Send Message</button>
            </div>
        </EditForm>

        <!-- Display response message -->
        @if (!string.IsNullOrWhiteSpace(responseMessage))
        {
            <div style="margin-top: 1rem; color: @(isMessageSent ? "green" : "red");">
                @responseMessage
            </div>
        }
    </div>
</div>

@code {
    private List<Employee> employeeList = new();
    private string serverUrl = "http://localhost:5002";
    private Communication newMessage = new();

    public int? UserId;
    private bool isMessageSent = false;
    private string responseMessage = string.Empty;

    public async Task GetUserId()
    {
        var user = await localStorage.GetItemAsync<Employee>("user");
        if (user != null)
        {
            UserId = user.Id;
            Console.WriteLine($"User found: UserId = {UserId}");
        }
        else
        {
            UserId = null;
            Console.WriteLine("User not found in localStorage");
        }
    }

    private void NavigateToInbox()
    {
        NavManager.NavigateTo("/myinbox");
    }

    private async Task LoadAllEmployees()
    {
        var response = await Http.GetFromJsonAsync<List<Employee>>($"{serverUrl}/api/employee/GetAllEmployees");
        employeeList = response ?? new List<Employee>();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAllEmployees();
        await GetUserId();
    }

    private async Task SendMessage()
    {
        newMessage.IdOfSender = UserId ?? 0;

            var response = await Http.PostAsJsonAsync($"{serverUrl}/api/communication/sendmessage", newMessage);

            if (response.IsSuccessStatusCode)
            {
                isMessageSent = true;
                responseMessage = "Message sent successfully!";
                NavManager.NavigateTo("/myinbox", true); // Navigate back
            }
            else
            {
                isMessageSent = false;
                    responseMessage = "Failed to send the message. Please try again.";
            }
        }

    }
}
